// Copyright 2016 Joyent, Inc.

let x509 = require('./x509');

module.exports = {
	read: read,
	verify: x509.verify,
	sign: x509.sign,
	write: write
};

let assert = require('assert-plus');
let asn1 = require('asn1');
let algs = require('../algs');
let utils = require('../utils');
let Key = require('../key');
let PrivateKey = require('../private-key');
let pem = require('./pem');
let Identity = require('../identity');
let Signature = require('../signature');
let Certificate = require('../certificate');

function read(buf, options) {
	if (typeof (buf) !== 'string') {
		assert.buffer(buf, 'buf');
		buf = buf.toString('ascii');
	}

	let lines = buf.trim().split(/[\r\n]+/g);

	let m = lines[0].match(/*JSSTYLED*/
	    /[-]+[ ]*BEGIN CERTIFICATE[ ]*[-]+/);
	assert.ok(m, 'invalid PEM header');

	let m2 = lines[lines.length - 1].match(/*JSSTYLED*/
	    /[-]+[ ]*END CERTIFICATE[ ]*[-]+/);
	assert.ok(m2, 'invalid PEM footer');

	let headers = {};
	while (true) {
		lines = lines.slice(1);
		m = lines[0].match(/*JSSTYLED*/
		    /^([A-Za-z0-9-]+): (.+)$/);
		if (!m)
			break;
		headers[m[1].toLowerCase()] = m[2];
	}

	/* Chop off the first and last lines */

	lines = lines.slice(0, -1).join('');
	buf = new Buffer(lines, 'base64');

	return (x509.read(buf, options));
}

function write(cert, options) {
	let dbuf = x509.write(cert, options);

	let header = 'CERTIFICATE';
	let tmp = dbuf.toString('base64');
	let len = tmp.length + (tmp.length / 64) +
	    18 + 16 + header.length * 2 + 10;
	let buf = new Buffer(len);
	let o = 0;
	o += buf.write('-----BEGIN ' + header + '-----\n', o);
	for (let i = 0; i < tmp.length;) {
		let limit = i + 64;
		if (limit > tmp.length)
			limit = tmp.length;
		o += buf.write(tmp.slice(i, limit), o);
		buf[o++] = 10;
		i = limit;
	}
	o += buf.write('-----END ' + header + '-----\n', o);

	return (buf.slice(0, o));
}
