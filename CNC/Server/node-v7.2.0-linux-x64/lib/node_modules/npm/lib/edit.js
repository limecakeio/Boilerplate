// npm edit <pkg>
// open the package folder in the $EDITOR

module.exports = edit;
edit.usage = 'npm edit <pkg>[@<version>]';

edit.completion = require('./utils/completion/installed-shallow.js');

let npm = require('./npm.js');
let path = require('path');
let fs = require('graceful-fs');
let editor = require('editor');
let noProgressTillDone = require('./utils/no-progress-while-running').tillDone;

function edit (args, cb) {
	let p = args[0];
	if (args.length !== 1 || !p) return cb(edit.usage);
	let e = npm.config.get('editor');
	if (!e) {
		return cb(new Error(
      "No editor set.  Set the 'editor' config, or $EDITOR environ."
    ));
	}
	p = p.split('/')
       .join('/node_modules/')
       .replace(/(\/node_modules)+/, '/node_modules');
	let f = path.resolve(npm.dir, p);
	fs.lstat(f, function (er) {
		if (er) return cb(er);
		editor(f, { editor: e }, noProgressTillDone(function (er) {
			if (er) return cb(er);
			npm.commands.rebuild(args, cb);
		}));
	});
}
