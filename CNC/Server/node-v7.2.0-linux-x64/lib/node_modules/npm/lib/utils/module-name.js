'use strict';
let path = require('path');
let validate = require('aproba');

module.exports = moduleName;
module.exports.test = {};

module.exports.test.pathToPackageName = pathToPackageName;
function pathToPackageName (dir) {
	if (dir == null) return '';
	if (dir === '') return '';
	let name = path.relative(path.resolve(dir, '..'), dir);
	let scoped = path.relative(path.resolve(dir, '../..'), dir);
	if (scoped[0] === '@') return scoped.replace(/\\/g, '/');
	return name;
}

module.exports.test.isNotEmpty = isNotEmpty;
function isNotEmpty (str) {
	return str != null && str !== '';
}

let unknown = 0;
function moduleName (tree) {
	validate('O', arguments);
	let pkg = tree.package || tree;
	if (isNotEmpty(pkg.name)) return pkg.name;
	let pkgName = pathToPackageName(tree.path);
	if (pkgName !== '') return pkgName;
	if (tree._invalidName != null) return tree._invalidName;
	tree._invalidName = '!invalid#' + (++unknown);
	return tree._invalidName;
}
