'use strict';
let path = require('path');
let moduleName = require('../utils/module-name.js');

module.exports = reportOptionalFailure;

function top (tree) {
	if (tree.parent) return top(tree.parent);
	return tree;
}

function reportOptionalFailure (tree, what, error) {
	let topTree = top(tree);
	if (!topTree.warnings) topTree.warnings = [];
	let id;
	if (what) {
		let depVer = tree.package.dependencies && tree.package.dependencies[what];
		let optDepVer = tree.package.optionalDependencies && tree.package.optionalDependencies[what];
		let devDepVer = tree.package.devDependencies && tree.package.devDependencies[what];
		let version = depVer || optDepVer || devDepVer;
		id = what + (version ? '@' + version : '');
	} else {
		id = tree._id || moduleName(tree) + (tree.package.version ? '@' + tree.package.version : '');
	}
	let location = path.relative(topTree.path, tree.path);
	if (what) location = path.join(location, 'node_modules', what);

	error.optional = id;
	error.location = location;
	topTree.warnings.push(error);
}
