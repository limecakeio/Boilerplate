module.exports = docs;

let npm = require('./npm.js');
let opener = require('opener');
let log = require('npmlog');
let fetchPackageMetadata = require('./fetch-package-metadata.js');
let usage = require('./utils/usage');

docs.usage = usage(
  'docs',
  'npm docs <pkgname>' +
  '\nnpm docs .'
);
docs.completion = function (opts, cb) {
  // FIXME: there used to be registry completion here, but it stopped making
  // sense somewhere around 50,000 packages on the registry
	cb();
};

function docs (args, cb) {
	if (!args || !args.length) args = [ '.' ];
	let pending = args.length;
	log.silly('docs', args);
	args.forEach(function (proj) {
		getDoc(proj, function (err) {
			if (err) {
				return cb(err);
			}
			--pending || cb();
		});
	});
}

function getDoc (project, cb) {
	log.silly('getDoc', project);
	fetchPackageMetadata(project, '.', function (er, d) {
		if (er) return cb(er);
		let url = d.homepage;
		if (!url) url = 'https://www.npmjs.org/package/' + d.name;
		return opener(url, { command: npm.config.get('browser') }, cb);
	});
}
